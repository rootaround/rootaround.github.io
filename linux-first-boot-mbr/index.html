<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="yandex-verification" content="377f121897ba8c7a" />
  
  <title>Linux First: Загрузка ядра | root around</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="После предыдущего поста “Кратко о linux-ядре” есть общее представление как устроено ядро. Дальше поговорим про загрузку компьютера в общем и ядра в частности. Попутно создадим образ жесткого диска, на">
<meta property="og:type" content="article">
<meta property="og:title" content="Linux First: Загрузка ядра">
<meta property="og:url" content="https://rootaround.github.io/linux-first-boot-mbr/index.html">
<meta property="og:site_name" content="root around">
<meta property="og:description" content="После предыдущего поста “Кратко о linux-ядре” есть общее представление как устроено ядро. Дальше поговорим про загрузку компьютера в общем и ядра в частности. Попутно создадим образ жесткого диска, на">
<meta property="og:locale" content="ru_RU">
<meta property="og:image" content="https://rootaround.github.io/css/images/linux-first/boot-mbr-1.png">
<meta property="og:image" content="https://rootaround.github.io/css/images/linux-first/boot-mbr-2.png">
<meta property="article:published_time" content="2020-05-14T17:00:00.000Z">
<meta property="article:modified_time" content="2020-10-01T06:25:44.037Z">
<meta property="article:author" content="alekzonder">
<meta property="article:tag" content="linux">
<meta property="article:tag" content="linux-first">
<meta property="article:tag" content="kernel">
<meta property="article:tag" content="boot">
<meta property="article:tag" content="mbr">
<meta property="article:tag" content="grub">
<meta property="article:tag" content="qemu">
<meta property="article:tag" content="initrd">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://rootaround.github.io/css/images/linux-first/boot-mbr-1.png">
  
    <link rel="alternate" href="/atom.xml" title="root around" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  
<link rel="stylesheet" href="/css/style.css">

  <link href="https://fonts.googleapis.com/css?family=Roboto:400,400i,500i,700" rel="stylesheet">
  

  

<meta name="generator" content="Hexo 5.4.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">root around</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">главная</a>
        
          <a class="main-nav-link" href="/toc">оглавление</a>
        
          <a class="main-nav-link" href="/archives">архив</a>
        
          <a class="main-nav-link" target="_blank" rel="noopener" href="https://t.me/rootaround">telegram</a>
        
          <a class="main-nav-link" target="_blank" rel="noopener" href="https://twitter.com/root_around">twitter</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS-каналы"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Поиск"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="https://rootaround.github.io"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-linux-first-boot-mbr" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/linux-first-boot-mbr/" class="article-date">
  <time datetime="2020-05-14T17:00:00.000Z" itemprop="datePublished">2020-05-15</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      Linux First: Загрузка ядра
    </h1>
  

      </header>
    

    <!-- <div class="article-entry article-nav-title">7 min. read</div> -->
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>После предыдущего поста <a href="/linux-first-shortly-about-kernel">“Кратко о linux-ядре”</a> есть общее представление как устроено ядро. Дальше поговорим про загрузку компьютера в общем и ядра в частности.</p>
<p>Попутно создадим образ жесткого диска, на базе которого продолжим разбираться с linux в следующих статьях.</p>
<span id="more"></span>
<h2 id="Загрузка-от-включения-ПК-до-устройства">Загрузка от включения ПК до устройства</h2>
<ul>
<li>После включения код BIOS загружается в оперативную память (ОЗУ) из постоянной памяти (ПЗУ)</li>
<li>После загрузки в ОЗУ код BIOS выполняет тест оборудования Power-On Self-Test (POST-тест)</li>
<li>Читает настройки BIOS из ПЗУ</li>
<li>Ищет и загружает в оперативную память код загрузчика</li>
<li>Передает управление загрузчику</li>
</ul>
<p>Кроме этого BIOS предоставляет API для работы с устройствами еще до загрузки Операционной Системы</p>
<p>Подробно останавливаться на этом этапе смысла нет,<br />
мы будем собирать образ диска с linux и загружать его используя эмулятор QEMU</p>
<details><summary>Подробнее про QEMU</summary>
<p><a target="_blank" rel="noopener" href="https://www.qemu.org/">https://www.qemu.org/</a></p>
<p>Эмулятор аппаратных платформ, позволяет эмулировать разные процессоры.</p>
<p>Мы будем использовать qemu для x86_64</p>
</details>
<h2 id="Загрузка-с-устройства">Загрузка с устройства</h2>
<div class="info">
<p>Все команды выполнялись на ubuntu 16.04</p>
</div>
<p>BIOS в зависимости от своих настроек выбирает устройство для загрузки или последовательно проверяет несколько устройств.</p>
<p>в случае с QEMU это выглядит так:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">$ qemu-system-x86_64 \ # запускаем эмулятор с архитектурой x86_64</span><br><span class="line">    -nographic \       # весь вывод будет в консоль, иначе откроется gui-окно</span><br><span class="line">    -m 128m            # оперативки будет 128 Мб - нам хватит</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">Booting from Hard Disk...</span><br><span class="line">Boot failed: could not read the boot disk</span><br><span class="line"></span><br><span class="line">Booting from Floppy...</span><br><span class="line">Boot failed: could not read the boot disk</span><br><span class="line"></span><br><span class="line">Booting from DVD/CD...</span><br><span class="line">Boot failed: Could not read from CDROM (code 0003)</span><br><span class="line">Booting from ROM...</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<div class="message">
<p>Выход из QEMU по <code>CTRL+a x</code></p>
</div>
<p>Ни CDROM, ни диск не указан, поэтому и загрузки не происходит.</p>
<p>Исправляем это и создаем маленький по современным меркам жесткий диск на 256 mb.</p>
<p>Перед созданием образа стоит поговорить про стандарты таблиц разделов на диске. Сейчас их два:</p>
<ul>
<li>MBR (Main Boot Record) - старый стандарт таблицы разделов (из 1983 года)</li>
<li>GPT (Guid Partition Table) - современный стандарт разделов, является частью стандарта EFI (Extensible Firmware Interface), разработанного Intel для замены BIOS</li>
</ul>
<p>Подробнее про стандарты будет ссылка в конце статьи. Сейчас сделаем образ с MBR, а как-нибудь в другой серии с GPT, потому что с ним все немного сложнее</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ dd if=/dev/zero of=./mbr_hdd.img bs=1024k count=256</span><br><span class="line">256+0 records in</span><br><span class="line">256+0 records out</span><br><span class="line">268435456 bytes transferred in 0.362737 secs (740027899 bytes/sec)</span><br></pre></td></tr></table></figure>
<details><summary>немного про dd</summary>
<p><code>dd</code> позволяет копировать файлы блоками заданного размера</p>
<p>в данном случае мы копируем нули из /dev/zero блоками по 1024 килобайт (1Mb) 256 раз</p>
<p>про dd и устройство файловой систему будем разбираться в следующих статьях</p>
</details>
<p>Если сразу попытаться подсунуть образ диска в qemu, то ничего не поменятся,<br />
так как на диске нет таблицы разделов, а только нули.</p>
<p>Создаем один загрузочный linux-раздел, например, с помощью fdisk (или cfdisk или parted)</p>
<p>Должно получиться так:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ fdisk -l ./mbr_hdd.img</span><br><span class="line">Disk ./mbr_hdd.img: 256 MiB, 268435456 bytes, 524288 sectors</span><br><span class="line">Units: sectors of 1 * 512 = 512 bytes</span><br><span class="line">Sector size (logical/physical): 512 bytes / 512 bytes</span><br><span class="line">I/O size (minimum/optimal): 512 bytes / 512 bytes</span><br><span class="line">Disklabel type: dos</span><br><span class="line">Disk identifier: 0x00000000</span><br><span class="line"></span><br><span class="line">Device         Boot Start    End Sectors  Size Id Type</span><br><span class="line">./mbr_hdd.img1 *     2048 524287  522240  255M 83 Linux</span><br></pre></td></tr></table></figure>
<p>Теперь на диске есть таблица разделов, пробуем загружаться:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">$ qemu-system-x86_64 -nographic -m 128m \</span><br><span class="line">  -boot c \          # загружаться с жесткого диска</span><br><span class="line">  -hda ./mbr_hdd.img # указываем образ первого жесткого диска</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">Booting from Hard Disk...</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>У нас есть жесткий диск, на нем есть таблица разделов, есть загрузочный раздел - пришло время поговорить про загрузчики.</p>
<h3 id="Загрузчик-bootloader">Загрузчик (bootloader)</h3>
<p>Для linux по большому счету существует два загрузчика: LILO и GRUB.</p>
<p>LILO считается устаревшим, он не умеет работать с файловыми системами и для его конфигурации нужно каждый раз обновлять загрузочную запись на диске. Его рассматривать не будем.</p>
<p>GRUB умеет работать с разными файловыми системами, multiboot, grub-shell, консоль восстановления и много чего еще.</p>
<p>Конфиги GRUB, архивы с ядрами и initrd можно смотреть и править в каталоге (разделе) <code>/boot</code>.</p>
<p>Для начала нужно создать файловую систему в разделе нашего hdd.</p>
<p>Для реальных hdd разделы диска будут отображатся с номерами в /dev и в выводе команды <code>lsblk</code> выглядят примерно так:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"># lsblk показывает блочные устройства в системе</span><br><span class="line"></span><br><span class="line">$ lsblk</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line">sda         8:0    0    10G  0 disk</span><br><span class="line">└─sda1      8:1    0    10G  0 part /mnt</span><br><span class="line">...</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>Видим что примонтирован диск sda с одним разделом sda1.<br />
Для нашего образа диска нам нужно как-то подключить файл образа как устройство.</p>
<p>Один из способов - команда <code>losetup</code>, с помощью нее можно подключать образы как блочные устройства.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">$ sudo losetup \</span><br><span class="line">    --find \      # ищет свободный id для блочного устройства</span><br><span class="line">    --partscan \  # ищет на устройстве разделы, а нас как раз один раздел</span><br><span class="line">    ./mbr_hdd.img</span><br><span class="line"></span><br><span class="line">$ lsblk</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line">loop0       7:0    0  256M  0 loop # видим наш диск с одним разделом</span><br><span class="line">└─loop0p1 259:0    0  255M  0 loop</span><br><span class="line">...</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>Теперь можем форматировать раздел в ext4:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ sudo mkfs.ext4 /dev/loop0p1</span><br><span class="line"></span><br><span class="line">mke2fs 1.42.13 (17-May-2015)</span><br><span class="line">...</span><br><span class="line">Writing superblocks and filesystem accounting information: done</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>Примонтируем раздел и посмотрим что на нем есть.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ mkdir /mnt/hdd               # создаем точку монтирования</span><br><span class="line"></span><br><span class="line">$ mount /dev/loop0p1 /mnt/hdd  # монтируем раздел</span><br><span class="line"></span><br><span class="line">$ ls -l /mnt/hdd               # внутри только lost+found</span><br><span class="line"></span><br><span class="line">total 12</span><br><span class="line">drwx------ 2 root root 12288 May 13 16:45 lost+found</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>Вот мы плавно и подошли к установке загрузчика - как говорил ранее, будем ставить grub.</p>
<p>При установке загрузчик будет записывать файлы непосредственно в файловую систему и изменять MBR на самом диске.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">sudo grub-install \</span><br><span class="line">    --root-directory=/mnt/hdd \  # тут нужно указывать полный путь до примонтированного раздела</span><br><span class="line">     /dev/loop0                  # тут указываем сам диск, а не раздел</span><br><span class="line"></span><br><span class="line">Installing for i386-pc platform.</span><br><span class="line">Installation finished. No error reported.</span><br></pre></td></tr></table></figure>
<p>На диске появилась директория <code>boot</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ ls -l /mnt/hdd/boot/grub/</span><br><span class="line">total 12</span><br><span class="line">drwxr-xr-x 2 root root 1024 May 13 16:50 fonts</span><br><span class="line">-rw-r--r-- 1 root root 1024 May 13 16:50 grubenv</span><br><span class="line">drwxr-xr-x 2 root root 9216 May 13 16:50 i386-pc</span><br><span class="line">drwxr-xr-x 2 root root 1024 May 13 16:50 locale</span><br><span class="line"></span><br><span class="line"># а команда file говорит так</span><br><span class="line">$ file mbr_hdd.img</span><br><span class="line">mbr_hdd.img: DOS/MBR boot sector</span><br></pre></td></tr></table></figure>
<p>Загрузчик установлен, пробуем загружаться в QEMU</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">$ qemu-system-x86_64 -nographic -m 128m -boot c -hda ./mbr_hdd.img</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">Booting from Hard Disk...</span><br><span class="line"></span><br><span class="line">                             GNU GRUB  version 2.02</span><br><span class="line"></span><br><span class="line">   Minimal BASH-like line editing is supported. For the first word, TAB</span><br><span class="line">   lists possible command completions. Anywhere else TAB lists possible</span><br><span class="line">   device or file completions.</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">grub&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>Видим приветствие GRUB и grub shell.</p>
<p>В шелле можно посмотреть диски, информацию по разделам, поставить классные картинки на boot-screen, но то что нам пригодится сейчас - это возможность указать путь до образа ядра и ram-диска.</p>
<h3 id="Загрузка-ядра">Загрузка ядра</h3>
<p>самый простой вариант получить образ ядра это скопировать его уже из готовой системы</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">ls -l /boot</span><br><span class="line">total 31584</span><br><span class="line">-rw-r--r-- 1 root root   217458 Apr 22 18:31 config-4.15.0-99-generic</span><br><span class="line">drwxr-xr-x 5 root root     4096 May 11 15:58 grub</span><br><span class="line">-rw-r--r-- 1 root root 19659681 May 11 15:57 initrd.img-4.15.0-99-generic</span><br><span class="line">-rw------- 1 root root  4071696 Apr 22 18:31 System.map-4.15.0-99-generic</span><br><span class="line">-rw------- 1 root root  8380056 Apr 22 18:32 vmlinuz-4.15.0-99-generic</span><br><span class="line"></span><br><span class="line">$ cp /boot/vmlinuz-4.15.0-99-generic /mnt/hdd/boot</span><br></pre></td></tr></table></figure>
<p>Запускаем QEMU и в консоли grub грузим ядро:</p>
<div class="info" style="margin-bottom: 15px">
<p>тут поменял -nographic на -curses, так лучше отображается в консоли, но этот ключ можно вообще убрать и работать в отдельном окне.</p>
</div>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">$ qemu-system-x86_64 -curses -m 128m -boot c -hda ./mbr_hdd.img</span><br><span class="line"></span><br><span class="line">grub&gt; ls /boot</span><br><span class="line">grub/ vmlinuz-4.15.0-99-generic                  # вот ядро в директории /boot</span><br><span class="line"></span><br><span class="line">grub&gt; linux /boot/vmlinuz-4.15.0-99-generic      # указываем какое ядро загружать</span><br><span class="line">grub&gt; boot                                       # загружаемся</span><br><span class="line"></span><br><span class="line">...                                              # тут лог загрузки</span><br><span class="line"></span><br><span class="line"># и в итоге получаем ошибку kernel panic</span><br><span class="line"></span><br><span class="line">[    2.159628] ---[ end Kernel panic - not syncing: VFS: Unable to mount root fs  on unknown-block(0,0)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<div class="message">
<p>В этом режиме чтобы выйти из виртуалки нужно перейти в QEMU monitor по <code>Ctrl-Alt-2</code> и выполнить команду <code>quit</code>. Подробнее про хоткеи в <a target="_blank" rel="noopener" href="https://qemu.weilnetz.de/doc/qemu-doc.html">доке</a> раздел  “2.4 Keys in the graphical frontends”</p>
</div>
<p>После загрузки ядро должно иметь временную файловую систему и из нее запустить первый процесс в пользовательском пространстве с pid=1.</p>
<p>Временная файловая система (ram-диск) это и есть initrd и этот образ нужно будет собрать.</p>
<p>После загрузки ядра при запуске пользовательского пространства нужны хоть какие-то команды и есть такой набор инструментов - busybox.</p>
<p>busybox - это один бинарный файл, который содержит в себе минимальный набор программ для работы с системой. Добавим busybox в сборке ram-диска.</p>
<h3 id="минимальный-initrd">минимальный initrd</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">mkdir initrd</span><br><span class="line">cd initrd</span><br><span class="line"></span><br><span class="line"># создаем основные директории</span><br><span class="line">mkdir bin sys dev proc</span><br><span class="line"></span><br><span class="line">#  загружаем busybox и расставляем симлинки</span><br><span class="line">wget https://busybox.net/downloads/binaries/1.30.0-i686/busybox -O bin/busybox</span><br><span class="line"></span><br><span class="line"># обязательно нужно добавить права на выполнение для busybox</span><br><span class="line">chmod +x bin/busybox</span><br><span class="line"></span><br><span class="line"># симлинки для некоторых команд, остальные добавим позже</span><br><span class="line">ln -s busybox bin/echo</span><br><span class="line">ln -s busybox bin/ash</span><br><span class="line">ln -s busybox bin/ls</span><br><span class="line">ln -s busybox bin/cat</span><br><span class="line"></span><br><span class="line"># копируем файлы устройств, про файлы в linux поговорим в других статьях</span><br><span class="line">cp -a /dev/console ./dev</span><br><span class="line">cp -a /dev/null ./dev</span><br><span class="line">cp -a /dev/tty1 ./dev</span><br><span class="line">cp -a /dev/tty2 ./dev</span><br><span class="line"></span><br><span class="line"># создаем скрипт с которого начнется запуск пользовательского пространства</span><br><span class="line"></span><br><span class="line">cat &gt;&gt; ./init &lt;&lt; EOF</span><br><span class="line">#!/bin/ash</span><br><span class="line">/bin/ash --login</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"># делаем скрипт исполняемым</span><br><span class="line">chmod +x init</span><br><span class="line"></span><br><span class="line"># из этой же директории пакуем initrd в cpio-архив</span><br><span class="line">find . | cpio -o -H newc | gzip -9 &gt; ../initrd.img</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>копируем полученный initrd.img в /boot на нашем hdd</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cd .. &amp;&amp; cp ./initrd.img /mnt/hdd/boot</span><br></pre></td></tr></table></figure>
<p>и запускаем qemu:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">$ qemu-system-x86_64 -curses -m 128m -boot c -hda ./mbr_hdd.img</span><br><span class="line"></span><br><span class="line">grub&gt; ls /boot</span><br><span class="line">grub/ vmlinuz-4.15.0-99-generic initrd.img</span><br><span class="line"></span><br><span class="line">grub&gt; linux /boot/vmlinuz-4.15.0-99-generic    # задаем ядро</span><br><span class="line">grub&gt; initrd /boot/initrd.img                  # задаем образ initrd</span><br><span class="line"></span><br><span class="line">grub&gt; boot                                     # грузимся</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">/ # ls</span><br><span class="line"></span><br><span class="line"> bin   dev   init  proc  root  sbin  sys</span><br></pre></td></tr></table></figure>
<p>Видим процесс загрузки ядра, после загрузки видим шелл, выполняем <code>ls</code> и видим содержимое диска - самый минимум грузится осталось немного автоматизировать процесс загрузки.</p>
<p>Настроим grub чтобы система стартовала без ручного ввода ядра и ram-диска.</p>
<p>Для этого достаточно в <code>/boot/grub</code> создать файл <code>grub.cfg</code> (для grub2 нужно именно расширение <code>.cfg</code>, а не <code>.conf</code>)</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">set default=0</span><br><span class="line">set timeout=5</span><br><span class="line"></span><br><span class="line">menuentry &#x27;linux&#x27; &#123;</span><br><span class="line">  linux /boot/vmlinuz-4.15.0-99-generic</span><br><span class="line">  initrd /boot/initrd.img</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>если снова запустить qemu - увидим меню выбора системы</p>
<p><img src="/css/images/linux-first/boot-mbr-1.png" alt="" /></p>
<p>потом загрузку ядра и шелл</p>
<p><img src="/css/images/linux-first/boot-mbr-2.png" alt="" /></p>
<h2 id="Итого">Итого</h2>
<p>В общих чертах разобрались с процессом загрузки и создали образ, в котором загружается ядро и первым процессом стартует shell (ash). Это только начало, дальше будем разбираться с файловой системой и с тем процесс должен быть запущен первым, да и вообще с процессами и не только.</p>
<h2 id="Примеры">Примеры</h2>
<p>Готовый образ из статьи можно взять тут:</p>
<p><a target="_blank" rel="noopener" href="https://github.com/rootaround/examples/tree/master/linux-first/2020-05-13-boot-mbr">https://github.com/rootaround/examples/tree/master/linux-first/2020-05-13-boot-mbr</a></p>
<h2 id="Ссылки">Ссылки</h2>
<ul>
<li>Про BIOS: <a target="_blank" rel="noopener" href="https://ru.wikipedia.org/wiki/BIOS">https://ru.wikipedia.org/wiki/BIOS</a></li>
<li>Про стандарты таблиц разделов MBR, GPT <a target="_blank" rel="noopener" href="https://losst.ru/chem-otlichaetsya-mbr-ot-gpt">https://losst.ru/chem-otlichaetsya-mbr-ot-gpt</a></li>
<li>Форматирование диска: <a target="_blank" rel="noopener" href="https://losst.ru/formatirovanie-diska-v-linux">https://losst.ru/formatirovanie-diska-v-linux</a></li>
<li>GRUB (wikipedia) <a target="_blank" rel="noopener" href="https://ru.wikipedia.org/wiki/GNU_GRUB">https://ru.wikipedia.org/wiki/GNU_GRUB</a></li>
<li>GNU GRUB официальная дока <a target="_blank" rel="noopener" href="https://www.gnu.org/software/grub/manual/grub/grub.html">https://www.gnu.org/software/grub/manual/grub/grub.html</a></li>
<li>IBM: Подробности процесса загрузки Linux <a target="_blank" rel="noopener" href="https://www.ibm.com/developerworks/ru/library/l-linuxboot/">https://www.ibm.com/developerworks/ru/library/l-linuxboot/</a></li>
</ul>
<!--
GRUB

- https://superuser.com/questions/130955/how-to-install-grub-into-an-img-file
- https://ru.wikibooks.org/wiki/Grub_2#%D0%92%D0%BE%D1%81%D1%81%D1%82%D0%B0%D0%BD%D0%BE%D0%B2%D0%BB%D0%B5%D0%BD%D0%B8%D0%B5_GRUB2_%D1%81_LiveCD
- https://www.gnu.org/software/grub/manual/grub/grub.html
- https://wiki.archlinux.org/index.php/GRUB_(%D0%A0%D1%83%D1%81%D1%81%D0%BA%D0%B8%D0%B9)#%D0%9A%D0%BE%D0%BD%D1%81%D0%BE%D0%BB%D1%8C_GRUB2
- https://serverfault.com/questions/869559/grub-hangs-before-menu-after-a-hdd-upgrade-how-to-debug



https://www.ibm.com/developerworks/library/l-initrd/
https://www.kernel.org/doc/html/v4.14/admin-guide/initrd.html
https://ru.wikipedia.org/wiki/BusyBox
https://habr.com/post/126427/

http://iportnov.blogspot.com/2010/03/linux-10.html

https://losst.ru/ustanovka-zagruzchika-grub
https://losst.ru/chem-otlichaetsya-mbr-ot-gpt

https://www.ibm.com/developerworks/ru/library/l-linuxboot/

https://unix.stackexchange.com/questions/124681/how-to-ssh-from-host-to-guest-using-qemu

https://losst.ru/sobiraem-yadro-linux

https://ru.wikipedia.org/wiki/Процесс_загрузки_Linux

https://losst.ru/ustanovka-zagruzchika-grub

https://losst.ru/nastrojka-zagruzchika-grub

https://wiki.archlinux.org/index.php/GRUB_(%D0%A0%D1%83%D1%81%D1%81%D0%BA%D0%B8%D0%B9)#%D0%9A%D0%BE%D0%BD%D1%81%D0%BE%D0%BB%D1%8C_GRUB2

-->
<hr />
<p><a href="/toc#linux-first">Все статьи серии “Linux First”</a></p>

      
    </div>
    <footer class="article-footer">

      

      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/boot/" rel="tag">boot</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/grub/" rel="tag">grub</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/initrd/" rel="tag">initrd</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/kernel/" rel="tag">kernel</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/linux/" rel="tag">linux</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/linux-first/" rel="tag">linux-first</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/mbr/" rel="tag">mbr</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/qemu/" rel="tag">qemu</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2020-12-linux-tools-shells-part-1-historical/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Следующий</strong>
      <div class="article-nav-title">
        
          Linux Tools: shells - историческая часть
        
      </div>
    </a>
  
  
    <a href="/linux-first-shortly-about-kernel/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Предыдущий</strong>
      <div class="article-nav-title">Linux First: Кратко о linux-ядре</div>
    </a>
  
</nav>

  
</article>


</section>
        
      </div>
      <footer id="footer">



  
    <aside id="sidebar" class="outer">
  
    

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Метки</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/ash/" rel="tag">ash</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/boot/" rel="tag">boot</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/grub/" rel="tag">grub</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/initrd/" rel="tag">initrd</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/kernel/" rel="tag">kernel</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/linux/" rel="tag">linux</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/linux-first/" rel="tag">linux-first</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/linux-tools/" rel="tag">linux-tools</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/mbr/" rel="tag">mbr</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/qemu/" rel="tag">qemu</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/shell/" rel="tag">shell</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Облако меток</h3>
    <div class="widget tagcloud">
      <a href="/tags/ash/" style="font-size: 15px;">ash</a> <a href="/tags/boot/" style="font-size: 10px;">boot</a> <a href="/tags/grub/" style="font-size: 10px;">grub</a> <a href="/tags/initrd/" style="font-size: 10px;">initrd</a> <a href="/tags/kernel/" style="font-size: 12.5px;">kernel</a> <a href="/tags/linux/" style="font-size: 20px;">linux</a> <a href="/tags/linux-first/" style="font-size: 12.5px;">linux-first</a> <a href="/tags/linux-tools/" style="font-size: 17.5px;">linux-tools</a> <a href="/tags/mbr/" style="font-size: 10px;">mbr</a> <a href="/tags/qemu/" style="font-size: 10px;">qemu</a> <a href="/tags/shell/" style="font-size: 17.5px;">shell</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Архив</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/01/">январь 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/12/">декабрь 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/05/">май 2020</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Недавние записи</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2021-01-linux-tools-shells-part-6-ash-functions/">Linux Tools: shells, ash #5 - ash syntax, functions</a>
          </li>
        
          <li>
            <a href="/2021-01-linux-tools-shells-part-5-ash-complex-commands/">Linux Tools: shells, ash #4 - ash syntax, complex commands, pipelines, conditions and loops</a>
          </li>
        
          <li>
            <a href="/2021-01-linux-tools-shells-part-4-ash-redirections/">Linux Tools: shells, ash #3 - ash syntax, redirections</a>
          </li>
        
          <li>
            <a href="/2020-12-linux-tools-shells-part-3-ash-commands/">Linux Tools: shells, ash #2 - ash syntax, simple commands</a>
          </li>
        
          <li>
            <a href="/2020-12-linux-tools-shells-part-2-ash-startup/">Linux Tools: shells, ash #1 - ash startup and arguments</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2021 alekzonder<br>
      Создано с помощью <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">главная</a>
  
    <a href="/toc" class="mobile-nav-link">оглавление</a>
  
    <a href="/archives" class="mobile-nav-link">архив</a>
  
    <a target="_blank" rel="noopener" href="https://t.me/rootaround" class="mobile-nav-link">telegram</a>
  
    <a target="_blank" rel="noopener" href="https://twitter.com/root_around" class="mobile-nav-link">twitter</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  
<link rel="stylesheet" href="/fancybox/jquery.fancybox.css">

  
<script src="/fancybox/jquery.fancybox.pack.js"></script>




<script src="/js/script.js"></script>


  </div>
</body>
</html>